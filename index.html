<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Trackers Touren & GPX-Tracks</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">   <!-- Icon library -->

  <style>
    /* CSS RESET */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ELEMENTS IN TITLE SECTION */

    #title-section {
      background-color: #fff;
      color: #072b47;
      padding: 10px 10px;
      border-bottom: 1px solid #ccc;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      height: 64px;
      box-sizing: border-box;
      overflow: visible;              /* allows content to overflow if needed */
      position: sticky;
      top: 0;                         /* stick to top */
      z-index: 2000;                  /* ensures it stays above other content */
    }

    .header-image {
      height: 40px;
      width: auto;
      border-radius: 4px;
    }

    .flex-spacer {
      flex-grow: 1;                   /* pushes buttons to the right */
    }

    .icon-btn {
      display: inline-flex;          /* center the icon */
      justify-content: center;
      align-items: center;
      width: 60px;                   /* fixed width */
      height: 40px;                  /* fixed height */
      background: #e6f3ff;
      border: none;                  /* remove native button border */
      border-radius: 8px;            /* rounded corners */
      cursor: pointer;               /* pointer on hover */
      transition: background 0.2s;   /* smooth hover effect */
    }

    .icon-btn i {
      color: #072b47;              /* icon color */
      font-size: 1.5rem;             /* icon size */
    }

    .icon-btn:hover {
      background: #b8dcff;         /* light blue hover background */
    }

    .hidden {
      display: none;
    }

    /* ELEMENTS IN FILTER PANEL */

    .filter-panel { 
      position: fixed;
      top: 64px;                 /* below header */
      right: 1.5rem;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      padding: 1rem 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      width: 220px;
      z-index: 2000;
      transform: translateY(-20px);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    .filter-panel.active {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;   /* enable clicks */
    }

    .filter-panel.hidden {
      display: none;
    }

    .filter-panel h3 {
      margin-bottom: 0.5rem;
      font-size: 1rem;
      color: #072b47;
    }

    .filter-panel label {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
      color: #333;
    }

    .filter-panel select {
      margin-top: 0.25rem;
      padding: 0.25rem 0.5rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    .filter-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 5px;
    }

    .filter-buttons .icon-btn {
      width: 40px;
      height: 40px;
    }

    .filter-buttons .icon-btn i {
      font-size: 1rem;
    }

    /* ELEMENTS IN BODY SECTION */

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f1f1f1;
      color: #333;
    }

    /* ELEMENTS IN MAP */
    
    #map { 
      display: none;
      position: absolute;
      top: 64px;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      background-color: #f9f9f9;
      overflow-y: hidden;
      /* height: calc(100vh - 64px); this created issues with leaflets being hidden under titlebar*/
    } 

    #map-spinner {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .leaflet-tour-title {
      position: relative;                     /* allows us to move it */
      max-height: 66px;
      left: 10px;                             /* distance from zoom buttons */
      background: rgba(255, 255, 255, 0.9);
      display: flex;             
      align-items: stretch;                   /* image matches text height */
      gap: 10px;                  
      padding: 4px 10px;
      margin-top: 10px;
      border-radius: 5px;
      font-weight: normal;
      font-size: 12px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
      text-overflow: ellipsis;
      white-space: normal;
      word-break: break-word;
    }

    .leaflet-tour-title img {
      height: auto;
      max-height: 3.6em;                      /* roughly 3 lines of text */
      width: auto;                
      border-radius: 3px;
      box-shadow: 0 0 3px rgba(0,0,0,0.25);
      object-fit: cover;          
      align-self: center;                     /* vertically center if smaller than text */
    }

    .leaflet-tour-title-text {
      display: flex;
      flex-direction: column;     
      gap: 0px;                   
      font-weight: normal;
      font-size: 12px;
    }

    .leaflet-tour-title-text strong {
      font-size: inherit;
      font-weight: bold;
    }

    .tour-info-row {
      display: flex;
      gap: 10px;          /* space between distance and surface */
    }

    #altitude-overlay {
      position: fixed; /* fixed so it stays above the map and viewport */
      left: 5px;
      right: 5px;
      bottom: 10px; /* initial offset from bottom */
      height: 20dvh; /* 20% of visible viewport height */
      max-height: 160px;
      min-height: 100px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      padding: 5px;
      z-index: 1000;
    }

    /* ELEMENTS IN GALLERY */

    #gallery {
      display: block;
      padding: 1rem;
      gap: 0.5rem;
      background-color: #f9f9f9;
      overflow-y: auto;
      height: calc(100vh - 64px);
    }

    .country-header { /* box with country info */
      display: flex;
      width: 100%;
      align-items: center;
      max-height: 40px;
      padding: 0.5rem;
      border-radius: 5px;
      background: #eee;
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }

    .country-header .flag {
      height: 16px;
      width: 24px;
      border-radius: 5px;
      flex-shrink: 0;
    }

    .country-content { /* box below country header */
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: stretch;
      align-content: flex-start;
      gap: 1rem;
      padding: 0.5rem 0;
      margin-bottom: 0.5rem;
    }

    /* ELEMENTS IN GRID VIEW */

    .gallery-item {
      width: 300px;
      max-height: 500px;
      display: flex;
      flex-direction: column;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem;
      overflow-y: auto;
      cursor: pointer;
    }

    .gallery-item img {
      width: 100%;
      border-radius: 5px;
      margin-bottom: 0.7rem;
    }

    .tour-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 0.4rem;
    }

    .tour-title .flag {
      height: 16px;
      width: 24px;
      border-radius: 2px;
      flex-shrink: 0;
      margin-bottom: 0;
    }

    .tour-desc,
    .tour-info,
    .tour-besonderheiten,
    .tour-strassenbelag {
      margin-top: 0.25rem;
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 0.4rem;
    }

    .tour-download {
      display: inline-block;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #0077cc;
      text-decoration: none;
      outline: none;
    }

    .tour-download:hover {
      text-decoration: underline;
    }

    .tour-download a {
      color: #0077cc;               /* text color */
      text-decoration: none;          /* remove underline */
      border: none;                   /* remove any border */
      outline: none;                  /* remove focus outline */
      background: none;               /* remove any background */
      padding: 0;                     /* remove padding so no box */
    }

    .tour-download a:hover {
      text-decoration: underline;     /* optional hover effect */
    }

    .carousel {                       /* Carousel */
      position: relative;
    }

    .carousel-image {
      max-width: 100%;
      border-radius: 5px;
      display: none;                  /* hidden by default */
    }

    .carousel-image.active {
      display: block;                 /* only active one shows */
    }

    .carousel-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.7);
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.2rem 0.3rem;
      border-radius: 3px;
    }

    .carousel-arrow.left { left: 0.5rem; }
    .carousel-arrow.right { right: 0.5rem; }

    /* ELEMENTS IN WEATHER VIEW */
    
    .tour-weather {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      text-align: center;               /* centers iframe + link */
      align-items: center;
      padding: 0.5rem;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    /* ELEMENTS IN LIST VIEW */

    .tour-table {                       /* Table container */
      border-collapse: separate;        /* separate rows for shadow */
      border-spacing: 0 0.5rem;         /* vertical gap between rows */
      width: 100%;                      /* stretch across screen */
      margin-bottom: 0rem;
      font-size: 0.9rem;
      table-layout: fixed;              /* optional: distributes columns evenly */
    }

    .tour-table th:first-child,         /* Wider first column */
    .tour-table td:first-child {
      width: 35%;
    }

    .tour-table th:not(:first-child),   /* Spread the remaining columns evenly */
    .tour-table td:not(:first-child) {
        width: auto;
     }

    .tour-table th {                    /* Table header */
      background-color: #f0f0f0;
      font-weight: bold;
      padding: 0.5rem 0.75rem;
      border: none;
      text-align: left;
    }

    .tour-table td {                        /* Table body cells */
      border: none;                         /* remove individual cell borders */
      padding: 0.25rem 0.5rem;
      vertical-align: middle;
      word-wrap: break-word;                /* prevent overflow on small screens */
    }

    .tour-table tbody tr {                  /* Each table row looks like a card */
      display: table-row;                   /* keep table semantics */
      background-color: #fff;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      border-radius: 6px;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    
    .tour-table tbody tr:hover {            /* Row hover effect */
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      background-color: #eef6ff;
      cursor: pointer;
    }

    .tour-name {                            /* Tour name cell: bold */
      font-weight: bold;
    }

    .tour-download a {                      /* Download link styling */
      color: #0077cc;
      text-decoration: none;
      border: none;
      outline: none;
      background: none;
      padding: 0;
      cursor: pointer;
      font-weight: 500;
    }

    .tour-download a:hover {
      text-decoration: underline;
    }

    .tour-name-wrapper {                    /* Wraps thumbnail + text neatly */
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .tour-thumbnail {                       /* Thumbnail styling */
      width: 40px;                          /* adjust size */
      height: 25px;     
      object-fit: cover;
      border-radius: 4px;
      flex-shrink: 0;
    }

  /* RESPONSIVE DESIGN FOR SMALL SCREENS */

    @media (max-width: 767px) {

      #title-section {
        gap: 0.2rem;                          /* space between buttons */
      }

      .header-image {
      height: 20px;
      width: auto;
      margin-right: 0.5rem;
      border-radius: 2px;
      }
      
      #title-section h1 {
        font-size: 1.25rem;
      }

      .icon-btn {
        width: 30px;                          /* fixed width */
        height: 20px;                         /* fixed height */
        border-radius: 4px;                   /* rounded corners */
      }

      .icon-btn i {
        font-size: 1rem;                      /* icon size */
      }

.leaflet-tour-title {
  white-space: nowrap;
  overflow: hidden;
  max-width: 70%; /* so it doesn‚Äôt collide with controls */
}


      .gallery-item {
        width: 100%;
        max-width: 400px;
        max-height: 500px;
        overflow: hidden;
      }

      .tour-table thead {
        display: none;
      }

      .tour-table th, .tour-table td {
        font-size: 0.7rem;
        padding: 0.15rem 0.35rem;
        text-overflow: ellipsis;
      }    

      .tour-name-wrapper span {
        display: -webkit-box;               /* for Chrome, Safari, Edge */
        -webkit-box-orient: vertical;       /* vertical orientation */
        -webkit-line-clamp: 2;              /* number of lines to show */
        display: box;                       /* fallback for older browsers */
        box-orient: vertical;               /* fallback orientation */
        line-clamp: 2;                      /* standard property (future-proof) */
        overflow: hidden;                   /* hide overflowing text */
        text-overflow: ellipsis;            /* show ‚Ä¶ at the end */
        line-height: 1.2em;                 /* control line spacing */
        max-height: calc(1.2em * 2);        /* restrict container height to 2 lines */
      }
    }

  </style>
</head>

<body>

  <div id="title-section">
    <img src="images/Trackers.jpeg" alt="The Tracker's Logo" class="header-image" />
    <h1>Touren & Tracks</h1>
    <div class="flex-spacer"></div>
    <button id="mapBtn" class="icon-btn"><i class="fa-solid fa-map-location-dot"></i></button>
    <button id="gridBtn" class="icon-btn"><i class="fa-solid fa-table-cells-large"></i></button>
    <button id="listBtn" class="icon-btn"><i class="fa-solid fa-list"></i></button>
    <button id="weatherBtn" class="icon-btn"><i class="fa-solid fa-cloud-sun-rain"></i></button>
    <button id="returnBtn" class="icon-btn"><i class="fa-solid fa-rotate-left"></i></button>
    <button id="filterBtn" class="icon-btn"><i class="fa-solid fa-filter"></i></button>

    <div id="filterPanel" class="filter-panel hidden">
      <label>
        Land:
        <select id="countryFilter">
                <option value="">Alle</option>
                <option value="Frankreich">Frankreich</option>
                <option value="Italien">Italien</option>
                <option value="Marokko">Marokko</option>
                <option value="Schweden">Schweden</option>
                <option value="Schweiz">Schweiz</option>
                <option value="Spanien">Spanien</option>
                <option value="Europa">Europa</option>
        </select>
      </label>
      <label>
        Schwierigkeit:
        <select id="levelFilter">
                <option value="">Alle</option>
                <option value="Leicht">Leicht</option>
                <option value="Mittel">Mittel</option>
                <option value="Schwer">Schwer</option>
        </select>
      </label>
      <label>
        Strassenbelag:
        <select id="surfaceFilter">
          <option value="">Alle</option>
                <option value="">Alle</option>
                <option value="Strasse">Strasse</option>
                <option value="Off-road">Off-road</option>
                <option value="Gemischt">Gemischt</option>
        </select>
      </label>
      <div class="filter-buttons">
        <button id="filterApplyBtn" class="icon-btn"><i class="fa-solid fa-check"></i></button>
        <button id="filterResetBtn" class="icon-btn"><i class="fa-solid fa-rotate-left"></i></button>
      </div>
    </div>
  </div>

  <div id="body-section">
    <div id="map">
    <div id="map-spinner"></div>
      <div id="altitude-overlay">
        <canvas id="altitudeChart" style="width: 100%; height: 100%"></canvas>
      </div>
    </div>
    <div id="gallery"></div>
  </div>
  
  <script src="/touren.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.0/gpx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>


    //FLAGS
    const flags = {
      "Frankreich": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='8' height='16' fill='%230034bf'/%3e%3crect x='8' width='8' height='16' fill='%23fff'/%3e%3crect x='16' width='8' height='16' fill='%23ed2939'/%3e%3c/svg%3e",
      "Italien": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='8' height='16' fill='%23009641'/%3e%3crect x='8' width='8' height='16' fill='%23fff'/%3e%3crect x='16' width='8' height='16' fill='%23ce2b37'/%3e%3c/svg%3e",
      "Schweiz": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16'%3e%3crect width='16' height='16' fill='%23ff0000'/%3e%3crect x='6' y='3' width='4' height='10' fill='%23fff'/%3e%3crect x='3' y='6' width='10' height='4' fill='%23fff'/%3e%3c/svg%3e",
      "Europa": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='24' height='16' fill='%230072c6'/%3e%3cg fill='%23ffd700'%3e%3ccircle cx='12' cy='3' r='0.9'/%3e%3ccircle cx='14.8' cy='3.8' r='0.9'/%3e%3ccircle cx='17' cy='6' r='0.9'/%3e%3ccircle cx='17.8' cy='8.8' r='0.9'/%3e%3ccircle cx='17' cy='11.6' r='0.9'/%3e%3ccircle cx='14.8' cy='13.8' r='0.9'/%3e%3ccircle cx='12' cy='14.6' r='0.9'/%3e%3ccircle cx='9.2' cy='13.8' r='0.9'/%3e%3ccircle cx='7' cy='11.6' r='0.9'/%3e%3ccircle cx='6.2' cy='8.8' r='0.9'/%3e%3ccircle cx='7' cy='6' r='0.9'/%3e%3ccircle cx='9.2' cy='3.8' r='0.9'/%3e%3c/g%3e%3c/svg%3e",
      "Marokko": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='24' height='16' fill='%23c1272d'/%3e%3cg transform='translate(12,8) scale(0.6)'%3e%3cpolygon points='0,-6 1.763,2.118 -5.706,-2.118 5.706,-2.118 -1.763,2.118' fill='none' stroke='%2300653a' stroke-width='1.5'/%3e%3c/g%3e%3c/svg%3e",
      "Schweden": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='24' height='16' fill='%23008cba'/%3e%3crect x='7' width='4' height='16' fill='%23ffc720'/%3e%3crect y='5' height='6' width='24' fill='%23ffc720'/%3e%3c/svg%3e",
      "Spanien": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='24' height='16' fill='%23aa151b'/%3e%3crect y='5' height='6' width='24' fill='%23f1bf00'/%3e%3c/svg%3e",
      "Norwegen": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='24' height='16' fill='%23ba0c2f'/%3e%3crect x='5' width='2' height='16' fill='%23015aaa'/%3e%3crect y='6' width='24' height='2' fill='%23015aaa'/%3e%3crect x='6' width='1' height='16' fill='%23fff'/%3e%3crect y='7' width='24' height='1' fill='%23fff'/%3e%3c/svg%3e",
    };
    
    // BUTTONS
    const controls = {
      mapBtn: document.getElementById("mapBtn"),
      gridBtn: document.getElementById("gridBtn"),
      listBtn: document.getElementById("listBtn"),
      weatherBtn: document.getElementById("weatherBtn"),
      filterBtn: document.getElementById("filterBtn"),
      returnBtn: document.getElementById('returnBtn')
    };

      // Define visible buttons for each view
      const views = { 
        mapSingleTrack: ["returnBtn"],
        mapFilteredTracks: ["returnBtn", "filterBtn"],
        grid: ["mapBtn", "listBtn", "weatherBtn", "filterBtn"],
        list: ["mapBtn", "gridBtn", "weatherBtn", "filterBtn"],
        weather: ["returnBtn"]
      };

      // Function to show/hide buttons based on current view
      function showView(view) {
        Object.values(controls).forEach(el => el.classList.add("hidden"));
        views[view].forEach(id => controls[id].classList.remove("hidden"));
      }

    // VARIABLES

      const mapEl = document.getElementById("map");
      const gallery = document.getElementById("gallery");


      let map;
      let mapInitialized = false; // flag to track if map is initialized
      let currentViewMode = "grid";
      let lastViewMode = null;
      let currentTrack;
      let allTracksLayers = [];

    // CODE FOR MAP

      // Function to initialize map view (independent of single track or all tracks view)
      function initializeMap() {
        
        mapEl.style.display = "block";
        gallery.style.display = "none";

        if (!mapInitialized) {
          map = L.map(mapEl)
          const baseLayers = {
            "Standard": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            }),
            "Topo": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            }),
            "Satellit": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { 
            })
          };

          baseLayers["Standard"].addTo(map);
          L.control.layers(baseLayers).addTo(map);

          // Add tour title to map
          const tourTitleDiv = L.DomUtil.create('div', 'leaflet-tour-title');
          tourTitleDiv.innerHTML = '';

          // Insert it right after the zoom buttons
          const zoomContainer = map.zoomControl.getContainer();
          zoomContainer.parentNode.insertBefore(tourTitleDiv, zoomContainer.nextSibling);

          // Store reference for later updates
          map.tourTitleDiv = tourTitleDiv;

          mapInitialized = true;
        }
      }

      // Function to render all tours on map (depending on filters)
      function renderMapFilteredTours() {
        initializeMap();
        showView("mapFilteredTracks");
        lastViewMode = currentViewMode;
        currentViewMode = "mapFilteredTracks";

        const overlay = document.getElementById("altitude-overlay");
        if (overlay) overlay.style.display = "none";
      
      if (currentTrack) {
        map.removeLayer(currentTrack);
        currentTrack = null;
      }
      allTracksLayers.forEach(layer => map.removeLayer(layer));
      allTracksLayers = [];

      const filtered = getFilteredTours();        // ‚Üê only filtered tours

      const groupBounds = L.latLngBounds();
      let loadedCount = 0;

       // Show spinner
        const spinner = document.getElementById("map-spinner");
        spinner.style.display = "block";
        
        const startIcon = L.divIcon({
          html: '<i class="fa-solid fa-location-dot" style="color: #77bb41; font-size: 20px;"></i>',
          className: '',                          // prevent Leaflet from adding default styles
          iconSize: [32, 32],                     // size of the div (matches font-size roughly)
          iconAnchor: [8, 20],                    // center-bottom anchor
          popupAnchor: [0, -32]
        });

        const endIcon = L.divIcon({
          html: '<i class="fa-solid fa-location-dot" style="color: #e63946; font-size: 20px;"></i>', // red for end
          className: '',
          iconSize: [32, 32],
          iconAnchor: [8, 20],
          popupAnchor: [0, -32]
        });

      filtered.forEach(tour => {
        const gpxLayer = new L.GPX(tour.gpx, {
          async: true,
          marker_options: {
            startIcon,
            endIcon,
          }
        }).on('loaded', e => {
          groupBounds.extend(e.target.getBounds());
          loadedCount++;
          if (loadedCount === filtered.length) {
            map.fitBounds(groupBounds);
            spinner.style.display = "none";         // hide spinner when all GPX files loaded
          }
        })
          .on('addline', e => {
            const polyline = e.line;

            const tooltipContent = `
              <div class="tooltip-wrapper" style="cursor:pointer; text-align:center; max-width: 110px; padding: 2px; white-space: normal; font-size: 11px; line-height: 1.2;">
                <div style="font-weight: bold; margin-bottom: 5px; overflow-wrap: break-word;">${tour.name}</div>

                <img src="${tour.bild[0]}" alt="${tour.name}" style="width: 90px; height: auto; border-radius: 3px; box-shadow: 0 0 3px rgba(0,0,0,0.25);">
              </div>
            `;
            polyline.bindTooltip(tooltipContent, {
              permanent: true,
              direction: 'top',
              className: 'custom-tooltip',
              interactive: true
            });

            polyline.getTooltip().on('click', () => {
             // Render single track view with overlay
                renderMapSingleTrack(tour.gpx, tour.pois);
            });

            polyline.on('click', () => {
              map.fitBounds(polyline.getBounds());
            });

          })
          .addTo(map);

        allTracksLayers.push(gpxLayer);
      });

      if (filtered.length === 0) {
        document.querySelector(".leaflet-tour-title").textContent = "Keine Touren gefunden";
        spinner.style.display = "none";
      } else {
        document.querySelector(".leaflet-tour-title").textContent = "Gefilterte Touren";
      }
    }

      // Function to render a single tour in the map
      function renderMapSingleTrack(gpxFile, tourPois) {
        initializeMap();
        showView("mapSingleTrack");
        lastViewMode = currentViewMode;
        currentViewMode = "mapSingleTrack";

        const overlay = document.getElementById("altitude-overlay");
          if (overlay) overlay.style.display = "none"; // hide until GPX loads

        const tour = touren.find(t => t.gpx === gpxFile);
        if (!tour) return;
        map.tourTitleDiv.innerHTML = `
        ${tour.bild && tour.bild.length ? `
          <img src="${tour.bild[0]}" alt="${tour.name}">
        ` : ''}
        <div class="leaflet-tour-title-text">
          <strong>${tour.name}</strong>
          <div class="tour-info-row">
            <span>Strecke: ${tour.distanz}</span>
            <span>Belag: ${tour.strassenbelag}</span>
          </div>
          <div class="tour-info-row">
            <span>Besonderheiten: ${tour.besonderheiten}</span>
          </div>
        </div>
        `;

        if (currentTrack) map.removeLayer(currentTrack);
        allTracksLayers.forEach(layer => map.removeLayer(layer));
        allTracksLayers = [];

        const startIcon = L.divIcon({
          html: '<i class="fa-solid fa-location-dot" style="color: #77bb41; font-size: 20px;"></i>',
          className: '',                    // prevent Leaflet from adding default styles
          iconSize: [32, 32],               // size of the div (matches font-size roughly)
          iconAnchor: [8, 20],              // center-bottom anchor
        });

        const endIcon = L.divIcon({
          html: '<i class="fa-solid fa-location-dot" style="color: #e63946; font-size: 20px;"></i>', // red for end
          className: '',
          iconSize: [32, 32],
          iconAnchor: [8, 20],
        });

        currentTrack = new L.GPX(gpxFile, {
          async: true,
          marker_options: {
            startIcon: startIcon,
            endIcon: endIcon,
          }

        }).on('loaded', function (e) {
          // Get the overlay element
          const overlay = document.getElementById('altitude-overlay');

          // Compute its height in pixels
          const overlayHeight = overlay.offsetHeight;

          // Fit GPX bounds with bottom padding equal to overlay height + a small margin
          map.fitBounds(e.target.getBounds(), {
            paddingBottomRight: [0, overlayHeight + 10], // 10px extra margin
            paddingTopLeft: [10, 10] // optional small margin at top/left
          });

          // Render altitude profile
          document.getElementById("altitude-overlay").style.display = "block"; // show
          renderAltitudeProfile(gpxFile);

        }).addTo(map);
      }

      // Global marker for chart-map sync
      let chartCursorMarker = null;

      function adjustOverlayForIOS() {
        const overlay = document.getElementById('altitude-overlay');
        if (!overlay) return;

        const vh = window.innerHeight * 0.01;
        const bottomOffset = 10; // base offset in px

        overlay.style.height = `${vh * 25}px`; // ~25% of visible height
        overlay.style.bottom = `${bottomOffset}px`; 
      }

      window.addEventListener('resize', adjustOverlayForIOS);
      window.addEventListener('orientationchange', adjustOverlayForIOS);
      adjustOverlayForIOS();

      // Function to render the altitude profile
      function renderAltitudeProfile(fixedGpxFile) {
        fetch(fixedGpxFile)
          .then(response => response.text())
          .then(gpxText => {
            const parser = new DOMParser();
            const xml = parser.parseFromString(gpxText, "application/xml");
            const trkpts = xml.getElementsByTagName("trkpt");

            let dataPoints = [];
            let totalDist = 0;
            let lastLat = null, lastLon = null;

            // Store also lat/lon for later lookup
            let geoPoints = [];

            function haversine(lat1, lon1, lat2, lon2) {
              const R = 6371e3; 
              const toRad = deg => deg * Math.PI / 180;
              const dLat = toRad(lat2 - lat1);
              const dLon = toRad(lon2 - lon1);
              const a = Math.sin(dLat/2)**2 +
                        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                        Math.sin(dLon/2)**2;
              return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            }

            for (let i = 0; i < trkpts.length; i++) {
              let lat = parseFloat(trkpts[i].getAttribute("lat"));
              let lon = parseFloat(trkpts[i].getAttribute("lon"));
              let eleTag = trkpts[i].getElementsByTagName("ele")[0];
              if (!eleTag) continue;
              let ele = parseFloat(eleTag.textContent);

              if (lastLat !== null && lastLon !== null) {
                totalDist += haversine(lastLat, lastLon, lat, lon);
              }
              
              let distKm = totalDist / 1000;

              dataPoints.push({ x: distKm, y: ele });
              geoPoints.push({ x: distKm, lat: lat, lon: lon });

              lastLat = lat;
              lastLon = lon;
            }

            const maxDist = dataPoints[dataPoints.length - 1].x;  // e.g., 53 km
            let rawStep = maxDist <= 20 ? 1 : maxDist <= 100 ? 5 : maxDist <= 200 ? 10 : 20;
            let step = Math.max(5, Math.ceil(rawStep / 5) * 5);

            // Build an array of ticks to guarantee multiples of step appear
            const ticksArray = [];
            for (let v = 0; v <= maxDist; v += step) {
              ticksArray.push(v);
            }
            const lastTick = Math.floor(maxDist / step) * step;
            if (!ticksArray.includes(lastTick)) ticksArray.push(lastTick);

            const ctx = document.getElementById('altitudeChart').getContext('2d');

            // Destroy previous chart
            if (window.altitudeChartInstance) window.altitudeChartInstance.destroy();

            // Prevent map move when interacting with chart on touch devices
            const altitudeDiv = document.getElementById("altitude-overlay");
            L.DomEvent.disableClickPropagation(altitudeDiv);
            L.DomEvent.disableScrollPropagation(altitudeDiv);

            // Vertical line plugin for Chart.js
            const verticalLinePlugin = {
              id: 'verticalLine',
              afterDraw: (chart) => {
                if (chart.tooltip?._active?.length) {
                  let ctx = chart.ctx;
                  let x = chart.tooltip._active[0].element.x;
                  let topY = chart.scales.y.top;
                  let bottomY = chart.scales.y.bottom;

                  ctx.save();
                  ctx.beginPath();
                  ctx.moveTo(x, topY);
                  ctx.lineTo(x, bottomY);
                  ctx.lineWidth = 1.5;
                  ctx.strokeStyle = 'red';
                  ctx.stroke();
                  ctx.restore();
                }
              }
            };

            // Create the chart
            window.altitudeChartInstance = new Chart(ctx, {
              type: 'line',
              data: {
                datasets: [{
                  label: 'Altitude (m)',
                  data: dataPoints,
                  borderColor: 'rgba(0, 120, 200, 1)',
                  backgroundColor: 'rgba(135, 206, 250, 0.5)',
                  fill: true,
                  tension: 0.1,
                  pointRadius: 0
                }]
              },
            options: {
              events: ['mousemove', 'mouseout', 'click', 'touchstart', 'touchmove'],
              responsive: true,
              maintainAspectRatio: false,
              plugins: { 
                legend: { display: false },
                tooltip: {
                  mode: 'index',
                  intersect: false,
                  enabled: true,
                  callbacks: {
                    label: function(context) {
                      const distKm = context.parsed.x;
                      const match = geoPoints.find(p => Math.abs(p.x - distKm) < 0.05);
                      if (match) {
                        updateMapMarker(match.lat, match.lon);
                      }
                      return `${Math.round(context.parsed.y)} m`;
                    }
                  }
                }
              },
              interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
              },
              scales: {
                x: {
                  type: 'linear',
                  title: { display: true, text: "Distanz (km)" },
                  min: 0,
                  max: maxDist,
                  grid: { display: false },
                  ticks: {
                    callback: function(value) {
                      return ticksArray.includes(value) ? value : null;
                    }
                  }
                },
                y: { title: { display: true, text: "H√∂he (m)" } }
              }
            },
            plugins: [verticalLinePlugin]
          });

          // Function to update marker on map
          function updateMapMarker(lat, lon) {
            if (!chartCursorMarker) {
              chartCursorMarker = L.circleMarker([lat, lon], {
                radius: 6,
                color: "red",
                fillColor: "red",
                fillOpacity: 0.9
              }).addTo(map);
            } else {
              chartCursorMarker.setLatLng([lat, lon]);
            }
          }
        });
      }
    
    // CODE FOR GALLERY

      // Function to initialize gallery (independent of view)
      function initializeGallery(selectedTour = null) {
        mapEl.style.display = "none";
        gallery.style.display = "block";
        gallery.innerHTML = "";

        const filtered = getFilteredTours(selectedTour);

        if (filtered.length === 0) {
          gallery.innerHTML = `<div style="padding: 1rem; font-style: italic; color: #666;">
          Keine Touren gefunden, die den Filtern entsprechen.
          </div>`;
          return;
        }

        // Group tours by country
        const grouped = {};
        filtered.forEach(t => {
          if (!grouped[t.country]) grouped[t.country] = [];
          grouped[t.country].push(t);
        });

        // Render country headers, sorted by number of tours
        Object.keys(grouped)
          .sort((a, b) => grouped[b].length - grouped[a].length)
          .forEach(country => {
            const header = document.createElement("div"); // Header stretches across page
            header.className = "country-header";
            header.innerHTML = `
              <img src="${flags[country] || ''}" alt="${country}" class="flag" 
                  style="height: 20px; vertical-align: middle; margin-right: 0.5rem;" />
              <span class="country-name" style="font-size: 1.2rem; font-weight: bold;">${country}</span>
            `;
            gallery.appendChild(header);

            const content = document.createElement("div"); // Content section under header
            content.className = "country-content";
            content.dataset.country = country;
            gallery.appendChild(content);
          });

        return grouped; // return tours so other functions can render them
      }

      // Function to render tours in grid view
      function renderGalleryGrid(selectedTour = null) {

        const grouped = initializeGallery(selectedTour);
          if (!grouped) return; // nothing to show

        showView("grid");
        lastViewMode = currentViewMode;
        currentViewMode = "grid";

        // Render all tours for this country
        Object.keys(grouped).forEach(country => {
          grouped[country].sort((a, b) => a.name.localeCompare(b.name));

          const content = gallery.querySelector(`.country-content[data-country="${country}"]`);

          grouped[country].forEach((t, index) => {
            const galleryItem = document.createElement("div");
            galleryItem.className = "gallery-item";
            galleryItem.dataset.trackName = t.name;

            const images = t.bild.map((filename, i) =>
              `<img src="${filename}" 
                    alt="${t.name}" 
                    class="carousel-image${i === 0 ? ' active' : ''}">`
            ).join("");

            galleryItem.innerHTML = `
              <div class="carousel" data-tour="${index}">
                <button class="carousel-arrow left">&#10094;</button>
                <div class="carousel-images">
                  ${images}
                </div>
                <button class="carousel-arrow right">&#10095;</button>
              </div>
              <div class="tour-title">
                <img src="${flags[t.country] || ''}" alt="${t.country}" class="flag" />
                ${t.name}
              </div>
              <div class="tour-desc">${t.beschreibung}</div>
              <div class="tour-info">Strecke: ${t.distanz}</div>
              <div class="tour-besonderheiten">Besonderheiten: ${t.besonderheiten}</div>
              <div class="tour-strassenbelag">Strassenbelag: ${t.strassenbelag}</div>
              <a class="tour-download" href="${t.gpx}" download>‚û§ GPX herunterladen</a>
            `;

            galleryItem.addEventListener("click", (event) => { // Open map when gallery box is clicked
              if (event.target.closest(".carousel-arrow") || event.target.closest(".tour-download")) {
                return;
              }
              renderMapSingleTrack(t.gpx);
            });

            content.appendChild(galleryItem);
          });
        });
        
          document.querySelectorAll(".carousel").forEach(carousel => { // Setup carousels for pictures

            const images = carousel.querySelectorAll(".carousel-image");
            let currentIndex = 0;

            const showImage = (index) => {
              images.forEach(img => img.classList.remove("active"));
              images[index].classList.add("active");
            };

            carousel.querySelector(".left").addEventListener("click", e => {
              e.stopPropagation();
              currentIndex = (currentIndex - 1 + images.length) % images.length;
              showImage(currentIndex);
            });

            carousel.querySelector(".right").addEventListener("click", e => {
              e.stopPropagation();
              currentIndex = (currentIndex + 1) % images.length;
              showImage(currentIndex);
            });
          });
        }

      // Function to render tours in weather view
      function renderGalleryWeather(selectedTour = null) {

        const grouped = initializeGallery(selectedTour);
          if (!grouped) return; // nothing to show

        showView("weather");
        lastViewMode = currentViewMode;
        currentViewMode = "weather";

        // Render all tours for this country
        Object.keys(grouped).forEach(country => {
          grouped[country].sort((a, b) => a.name.localeCompare(b.name));

          const content = gallery.querySelector(`.country-content[data-country="${country}"]`);

          grouped[country].forEach((t, index) => {
            const galleryItem = document.createElement("div");
            galleryItem.className = "gallery-item";
            galleryItem.dataset.trackName = t.name;
      
          galleryItem.innerHTML = `

            <div class="tour-title" style="font-weight: bold; margin-top: 0.1rem;">
              <img src="${flags[t.country] || ''}" alt="${t.country}" class="flag" style="height: 16px; vertical-align: middle; margin-right: 0.1rem;" />
              ${t.name}
            </div>
            
            <!-- Weather Widget -->
            <div class="tour-weather" style="margin-top: 1rem;">
            <iframe
              src="https://www.meteoblue.com/de/weather/widget/daily/${t.cityId.toLowerCase().replace(/\s+/g,'-')}_${t.country.toLowerCase()}_${t.cityId}?geoloc=fixed&days=5&tempunit=CELSIUS&windunit=KILOMETER_PER_HOUR&precipunit=MILLIMETER&coloured=coloured&pictoicon=1&maxtemperature=1&mintemperature=1&windspeed=1&windgust=0&winddirection=0&uv=0&humidity=0&precipitation=1&precipitationprobability=1&spot=0&pressure=0&layout=light"
              frameborder="0"
              scrolling="NO"
              allowtransparency="true"
              sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"
              style="width: 230px; height: 270px">
            </iframe>
            <div>
              <a href="https://www.meteoblue.com/de/weather/week/${t.cityId.toLowerCase().replace(/\s+/g,'-')}_${t.country.toLowerCase()}_${t.cityId}" target="_blank" rel="noopener"/a>
            </div>
          </div>
          `;

          content.appendChild(galleryItem);
        });
      });
    }

    // Function to render tours in list view
      function renderGalleryList(selectedTour = null) {
        
        const grouped = initializeGallery(selectedTour);
          if (!grouped) return; // nothing to show
        
        showView("list");
        lastViewMode = currentViewMode;
        currentViewMode = "list";

        // Render all tours for this country
        Object.keys(grouped).forEach(country => {
          grouped[country].sort((a, b) => a.name.localeCompare(b.name));

          const content = gallery.querySelector(`.country-content[data-country="${country}"]`);

          const table = document.createElement("table"); // Create one table per country
          table.className = "tour-table";
       
          table.innerHTML = `
            <thead>
              <tr>
                <th>Tour</th>
                <th>Distanz</th>
                <th>Schwierigkeit</th>
                <th>Strassenbelag</th>
                <th>Download</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          `;
          const tbody = table.querySelector("tbody");

          grouped[country].forEach(t => { // Add each tour as a row
            const row = document.createElement("tr"); 

              const thumbnail = t.bild && t.bild.length > 0 ? t.bild[0] : "images/placeholder.jpg";

          row.innerHTML = `
            <td class="tour-name">
              <div class="tour-name-wrapper">
                     <img src="${thumbnail}" alt="${t.name}" class="tour-thumbnail" />
        <span>${t.name}</span>
        </div>
        </td>
            <td class="tour-distance">${t.distanz}</td>
            <td class="tour-difficulty">${t.schwierigkeit}</td>
            <td class="tour-surface">${t.strassenbelag}</td>
            <td class="tour-download"><a href="${t.gpx}" download>‚û§ GPX</a></td>`;  

          // Click to open in map
          row.addEventListener("click", () => {
            renderMapSingleTrack(t.gpx);
          });

          tbody.appendChild(row);
        });
        
        content.appendChild(table);
      });
    }
    
    // BUTTON HANDLERS

      mapBtn.addEventListener("click", () => renderMapFilteredTours());
      gridBtn.addEventListener("click", () => renderGalleryGrid());
      listBtn.addEventListener("click", () => renderGalleryList());
      weatherBtn.addEventListener("click", () => renderGalleryWeather());
      returnBtn.addEventListener("click", () => {
        if (lastViewMode === "grid") {
          renderGalleryGrid();
        } else if (lastViewMode === "list") {
          renderGalleryList();
        } else if (lastViewMode === "weather") {
          renderGalleryWeather();
        } else if (lastViewMode === "mapFilteredTracks") {
          renderMapFilteredTours();
        } else {
          renderGalleryGrid(); // fallback if nothing stored
        }
      });

    // FILTER FUNCTIONALITY

    document.addEventListener("DOMContentLoaded", () => {
      const filterBtn = document.getElementById("filterBtn");
      const filterPanel = document.getElementById("filterPanel");
      const filterApplyBtn = document.getElementById("filterApplyBtn");
      const filterResetBtn = document.getElementById("filterResetBtn");

      // Prevent clicks inside the panel from closing it
      filterPanel.addEventListener("click", (e) => {
        e.stopPropagation();
      });

      // Toggle filter panel
      filterBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // Prevent click from triggering document listener
        toggleFilterPanel();
      });

      // Close panel when clicking outside
      document.addEventListener("click", () => {
        if (filterPanel.classList.contains("active")) {
          closeFilterPanel();
        }
      });

      function toggleFilterPanel() {
        if (filterPanel.classList.contains("active")) {
          closeFilterPanel();
        } else {
          openFilterPanel();
        }
      }

      function openFilterPanel() {
        filterPanel.classList.add("active");
        filterPanel.classList.remove("hidden");
      }

      function closeFilterPanel() {
        filterPanel.classList.remove("active");
        setTimeout(() => filterPanel.classList.add("hidden"), 250);
      }

      // Apply filters
      filterApplyBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        applyFilters();
        closeFilterPanel();
      });

      // Reset filters
      filterResetBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        countryFilter.value = "";
        levelFilter.value = "";
        surfaceFilter.value = "";
        applyFilters();
        closeFilterPanel();
      });

      // Function to refresh the current view
      function applyFilters() {
        if (currentViewMode === "grid") {
          renderGalleryGrid();
        } else if (currentViewMode === "list") {
          renderGalleryList();
        } else if (currentViewMode === "mapFilteredTracks") {
          renderMapFilteredTours();
        }
      }
    });


      // Function to get filtered tours based on selected filters. If a specific tour is selected, return that tour only.
      // Otherwise, return all tours that match the filters. If no filters are selected, return all tours
        function getFilteredTours(selectedTour = null) {
        const countryValue = countryFilter.value.toLowerCase();
        const levelValue = levelFilter.value.toLowerCase();
        const surfaceValue = surfaceFilter.value.toLowerCase();

        if (selectedTour) {
          return [selectedTour];
        }

        return touren.filter(t =>
          (!countryValue || t.country.toLowerCase() === countryValue) &&
          (!levelValue || t.schwierigkeit.toLowerCase() === levelValue) &&
          (!surfaceValue || t.strassenbelag.toLowerCase() === surfaceValue)
        );
      }

    // ACTIONS ON PAGE LOAD

    // Show gallery by default
      renderGalleryGrid();

    // Show one-time tip overlay
    if (!localStorage.getItem('tourClickHintShown')) {
      const hint = document.createElement('div');
      hint.textContent = 'üí° Klicke auf eine Tour, um sie auf der Karte zu sehen.';
      hint.style.position = 'fixed';
      hint.style.top = '75px'; // adjust depending on your header height
      hint.style.left = '50%';
      hint.style.transform = 'translateX(-50%)';
      hint.style.background = 'rgba(0,0,0,0.65)';
      hint.style.color = '#fff';
      hint.style.padding = '8px 14px';
      hint.style.borderRadius = '5px';
      hint.style.fontSize = '14px';
      hint.style.zIndex = 9999;
      hint.style.opacity = '0';
      hint.style.transition = 'opacity 0.5s ease';

      document.body.appendChild(hint);

      // Fade in
      requestAnimationFrame(() => {
        hint.style.opacity = '1';
      });

      // Fade out after 3 seconds
      setTimeout(() => {
        hint.style.opacity = '0';
        setTimeout(() => hint.remove(), 500);
      }, 3000);
      
      localStorage.setItem('tourClickHintShown', 'true');
    }

  </script>
</body>
</html>