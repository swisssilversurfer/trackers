<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trackers Touren & GPX-Tracks</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f1f1f1;
      color: #333;
    }

    /* ELEMENTS IN TITLE SECTION */

    #title-section {
      background-color: #fff;
      padding: 10px 10px; /* <-- adjust padding for better spacing */
      padding-left: 15px;
      padding-right: 15px;
      border-bottom: 1px solid #ccc;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      height: 64px;
      box-sizing: border-box;
      overflow: visible; /* allows content to overflow if needed */

      position: sticky;
      top: 0;            /* <-- stick to top */
      z-index: 1000;     /* <-- ensures it stays above other content */
    }

    .header-image {
      height: 40px;
      width: auto;
      border-radius: 4px;
    }

    #header h1 {
      flex-shrink: 0;
      font-size: 1rem;
      color: #333;
      margin-right: 1rem;
    }

    .flex-spacer {
      flex-grow: 1;
    }

    #button-bar {
      display: flex;           /* horizontal layout */
      flex-wrap: wrap;         /* wrap if needed */
      gap: 0.5rem;             /* spacing between buttons */
      justify-content: flex-end; /* align buttons to the right */
      align-items: center;     /* vertical alignment with header/title */
      width: auto;             /* only as wide as needed */
      min-height: 25px;        /* ensures consistent height */
      overflow: visible; /* allows content to overflow if needed */
    }

    .app-button {
      padding: 0.4rem 0.5rem;   /* controls height */
      font-size: 0.8rem;         /* consistent font size */
      line-height: 1.2;          /* vertically center text */
      cursor: pointer;
      background-color: #0066cc;
      color: white;
      border: none;
      border-radius: 5px;
      white-space: nowrap;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;

      display: flex;
      align-items: center;
      justify-content: center;
    }

    .filter-dropdown {
      position: relative;
      display: flex;              /* aligns filterToggle button with others */
      font-size: 0.8rem;          /* unify with buttons */
    }

    .filter-menu {
      position: absolute;
      top: 100%;
      right: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 0.5rem 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      display: none;              /* shown via JS */
      z-index: 2000;
      min-width: 300px;
      font-size: 0.8rem;          /* unify with buttons */
    }

    .filter-menu.active {
      display: block;
    }

    /* FILTER MENU GROUPS */
    .filter-menu .filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem 1rem;
      align-items: center;
      font-size: 0.8rem;          /* unify with buttons */
    }

    .filter-menu .filter-group label {
      font-weight: 500;
      font-size: 0.8rem;
      margin-right: 0.5rem;
      white-space: nowrap;
      line-height: 1.2; /* vertically center label */
    }

    .filter-menu .filter-group select {
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
      background: white;
      min-width: 100px;
      margin-left: auto;
    }

    /* FILTER RESET BUTTON */
    #filterResetBtn {
      margin-top: 0.5rem;
      padding: 0.25rem 0.5rem;    /* match buttons */
      font-size: 0.8rem;
      line-height: 1.2;
      border-radius: 5px;
    }

    /* ELEMENTS IN BODY SECTION */

    #body-section {
      background-color: #f4f4f4;
    }

    #map {
      display: flex;
      height: calc(100vh - 64px);
    }

    #map-spinner {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1000;
      border: 6px solid #f3f3f3;
      border-top: 6px solid #3498db;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    #altitude-overlay {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      height: 200px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc; /* thinner, light grey */
      border-radius: 8px;
      box-shadow: 0px 3px 8px rgba(0,0,0,0.15);
      padding: 10px 20px;
      z-index: 9999;
    }

    #gallery {
      display: none;
      flex-wrap: wrap;
      justify-content: center;
      padding: 10px 1.5rem 1.5rem 1.5rem;
      gap: 2rem;
      background-color: #f9f9f9;
      overflow-y: auto;
      max-height: calc(100vh - 64px);
    }

    .gallery-item {
      width: 300px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 1rem;
      max-height: 500px;
      overflow-y: auto;
      cursor: pointer;
    }

    .gallery-item img {
      width: 100%;
      border-radius: 5px;
      margin-bottom: 0.7rem;
    }

    .tour-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 0.4rem;
    }

    .tour-title img.flag {
      width: 24px;
      height: 16px;
      border: 1px solid #ccc;
      border-radius: 2px;
      flex-shrink: 0;
      vertical-align: middle;
      margin-bottom: 0;
    }

    .tour-desc,
    .tour-info,
    .tour-besonderheiten,
    .tour-strassenbelag {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 0.4rem;
    }

    .tour-weather {
      margin-top: 1rem;
      text-align: center; /* centers iframe + link */
    }

    .tour-weather {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .tour-download {
      font-size: 0.85rem;
      color: #0066cc;
      text-decoration: none;
    }

    .tour-download:hover {
      text-decoration: underline;
    }

    .leaflet-tour-title {
      position: relative;        /* allows us to move it */
      left: 20px;                /* distance from zoom buttons */
      background: rgba(255, 255, 255, 0.9);
      display: flex;             
      align-items: stretch;      /* image matches text height */
      gap: 10px;                  
      padding: 4px 10px;
      margin-top: 10px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 14px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    }

    .leaflet-tour-title img {
      height: auto;
      max-height: 3.6em;         /* roughly 3 lines of text */
      width: auto;                
      border-radius: 3px;
      box-shadow: 0 0 3px rgba(0,0,0,0.25);
      object-fit: cover;          
      align-self: center;        /* vertically center if smaller than text */
    }

    .leaflet-tour-title-text {
      display: flex;
      flex-direction: column;     
      gap: 2px;                   
      font-weight: normal;
      font-size: 12px;
    }

    .leaflet-tour-title-text strong {
      font-size: 14px;
      font-weight: bold;
    }

    .custom-tooltip {
      background-color: #f9f9f9;
      border-radius: 6px;
      padding: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      color: #333;
      font-size: 13px;
      max-width: 140px;
    }

    /* Elements in list view */

    .tour-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      margin-top: 0;
    }

    .tour-table th,
    .tour-table td {
      border: 1px solid #ccc;
      padding: 0.25rem 1rem;
      text-align: left;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }

    /* Wider first column */
    .tour-table th:first-child,
    .tour-table td:first-child {
        width: 35%;  /* make first column wider */
    }

    /* Spread the remaining columns evenly */
    .tour-table th:not(:first-child),
    .tour-table td:not(:first-child) {
        width: auto;  /* remaining space is divided evenly */
    }

    .tour-table th {
      background-color: #f0f0f0;
      font-weight: bold;
      width: 20%; /* Adjust based on column count */
    }

    .tour-table tr:hover {
      background-color: #eef6ff;
      cursor: pointer;
    }

    .country-header {
      display: flex;
      align-items: center;
      padding: 0.6rem;
      background: #eee;
      font-weight: bold;
      border-radius: 5px;
      margin-top: 0.5rem;
           margin-top: 0rem;
      width: 100%;
      max-height: 50px;
    }

    .country-header .flag {
      height: 20px;
      margin-right: 0.5rem;
    }

    .carousel {
      position: relative;
      display: flex;
      align-items: center;
    }

    .carousel-images {
      flex: 1;
      overflow: hidden;
    }

    .carousel-arrow {
      background: rgba(0,0,0,0.4);
      color: white;
      border: none;
      padding: 0.5rem;
      cursor: pointer;
      font-size: 1.2rem;
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 2;
    }

    .carousel-arrow.left {
      left: 5px;
    }

    .carousel-arrow.right {
      right: 5px;
    }

    /* Specific styles for mobile devices */

    @media (max-width: 767px) {

      #title-section {
        flex-direction: column;
        align-items: flex-start;
        height: auto;
        padding: 10px 15px;
      }

      #title-section {
        display: flex;
        flex-direction: column;
        gap: 4px;  /* vertical spacing between title and buttons */
        padding: 10px 15px;
      }

      #title-section h1 {
        font-size: 1.25rem;
      }

      .header-image {
        display: none;
      }

      #button-bar {
        display: grid;
        grid-template-columns: 1fr 1fr; /* two equal columns */
        gap: 10px; /* spacing between buttons */
        width: 100%; /* make sure the grid spans container */
      }

      #button-bar button {
        width: 100%;       /* each button fills its grid cell */
        padding: 6px 15px; /* more padding for better touch targets */
        text-align: center;
        font-size: 0.75rem;
      }

      .filter-menu {
        width: 100%;
        left: 0;
        right: 0;
        min-width: unset;
        max-width: 100vw;
        box-sizing: border-box;
        padding: 1rem 0.5rem 0.5rem 0.5rem;
        overflow-x: hidden;
      }

      .filter-menu .filter-group {
        width: 100%;
        max-width: 100vw;
        display: flex;
        flex-direction: column;
        gap: 0.7rem;
      }

      .filter-menu .filter-group select,
      #filterResetBtn {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        font-size: 1rem;
        margin-left: 0;
        font-size: 0.75rem
      }

      /* Map & Gallery adjustments */

      #map,
      #gallery {
        height: calc(100vh - (64px));
      }

      #altitude-overlay {
        bottom: 10px;
        left: 5px;
        right: 5px;
        height: 160px;
      }

      /* Make gallery scrollable nicely on small */
      #gallery {
        padding: 10px 10px 10px 10px;
        max-height: calc(100vh - 130px);
      }

      /* Gallery items can be full width or smaller */
      .gallery-item {
        width: 100%;
        max-width: 400px;
        max-height: 500px;
        overflow: hidden;
      }

      .tour-table th,
      .tour-table td {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        text-overflow: ellipsis;
      }

    }
  </style>
</head>

<body>

  <div id="title-section">
    <img src="images/Trackers.jpeg" alt="The Tracker's Logo" class="header-image" />
    <h1>Touren & GPS-Tracks</h1>
    <div class="flex-spacer"></div>
    <div id="button-bar">
    <button id="showMapBtn" class="app-button">Karte</button>
    <button id="showGalleryBtn" class="app-button">Galerie</button>
    <button id="showGalleryListViewBtn" class="app-button">Listenansicht</button>
    <button id="showGalleryGridViewBtn" class="app-button">Gitteransicht</button>
    <button id="showGalleryGridViewMeteoBtn" class="app-button">Wetter</button>
    <button id="backBtn" class="app-button">Zur√ºck</button>
    <div class="filter-dropdown">
      <button id="filterToggle" class="app-button" aria-haspopup="true" aria-expanded="false">Filter ‚ñº</button>
      <div id="filterMenu" class="filter-menu" role="menu" aria-hidden="true">
        <div class="filter-group">
          <label for="regionFilter">Region:</label>
          <select id="regionFilter">
            <option value="">Alle</option>
            <option value="Frankreich">Frankreich</option>
            <option value="Italien">Italien</option>
            <option value="Marokko">Marokko</option>
            <option value="Schweden">Schweden</option>
            <option value="Schweiz">Schweiz</option>
            <option value="Spanien">Spanien</option>
            <option value="Europa">Europa</option>
          </select>
          <label for="levelFilter">Schwierigkeit:</label>
          <select id="levelFilter">
            <option value="">Alle</option>
            <option value="Leicht">Leicht</option>
            <option value="Mittel">Mittel</option>
            <option value="Schwer">Schwer</option>
          </select>
          <label for="surfaceFilter">Strassenbelag:</label>
          <select id="surfaceFilter">
            <option value="">Alle</option>
            <option value="Strasse">Strasse</option>
            <option value="Off-road">Off-road</option>
            <option value="Gemischt">Gemischt</option>
          </select>
        </div>
        <button id="filterResetBtn"  class="app-button" type="button" style="margin-top:0.5rem;">Filter zur√ºcksetzen</button>
      </div>
    </div>
    </div>
  </div>

  <div id="body-section">
    <div id="map">
      <div id="map-spinner"></div>
      <div id="altitude-overlay">
        <canvas id="altitudeChart" style="width: 100%; height: 100%"></canvas>
      </div>
    </div>
    <div id="gallery"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.0/gpx.min.js"></script>
  <script src="/touren.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>

    let mapInitialized = false;

    /* =======================
       FLAGS
       ======================= */
    const flags = {
      "Frankreich": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='8' height='16' fill='%230034bf'/%3e%3crect x='8' width='8' height='16' fill='%23fff'/%3e%3crect x='16' width='8' height='16' fill='%23ed2939'/%3e%3c/svg%3e",
      "Italien": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='8' height='16' fill='%23009641'/%3e%3crect x='8' width='8' height='16' fill='%23fff'/%3e%3crect x='16' width='8' height='16' fill='%23ce2b37'/%3e%3c/svg%3e",
      "Schweiz": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16'%3e%3crect width='16' height='16' fill='%23ff0000'/%3e%3crect x='6' y='3' width='4' height='10' fill='%23fff'/%3e%3crect x='3' y='6' width='10' height='4' fill='%23fff'/%3e%3c/svg%3e",
      "Europa": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='24' height='16' fill='%230072c6'/%3e%3cg fill='%23ffd700'%3e%3ccircle cx='12' cy='3' r='0.9'/%3e%3ccircle cx='14.8' cy='3.8' r='0.9'/%3e%3ccircle cx='17' cy='6' r='0.9'/%3e%3ccircle cx='17.8' cy='8.8' r='0.9'/%3e%3ccircle cx='17' cy='11.6' r='0.9'/%3e%3ccircle cx='14.8' cy='13.8' r='0.9'/%3e%3ccircle cx='12' cy='14.6' r='0.9'/%3e%3ccircle cx='9.2' cy='13.8' r='0.9'/%3e%3ccircle cx='7' cy='11.6' r='0.9'/%3e%3ccircle cx='6.2' cy='8.8' r='0.9'/%3e%3ccircle cx='7' cy='6' r='0.9'/%3e%3ccircle cx='9.2' cy='3.8' r='0.9'/%3e%3c/g%3e%3c/svg%3e",
      "Marokko": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='24' height='16' fill='%23c1272d'/%3e%3cg transform='translate(12,8) scale(0.6)'%3e%3cpolygon points='0,-6 1.763,2.118 -5.706,-2.118 5.706,-2.118 -1.763,2.118' fill='none' stroke='%2300653a' stroke-width='1.5'/%3e%3c/g%3e%3c/svg%3e",
      "Schweden": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='24' height='16' fill='%23008cba'/%3e%3crect x='7' width='4' height='16' fill='%23ffc720'/%3e%3crect y='5' height='6' width='24' fill='%23ffc720'/%3e%3c/svg%3e",
      "Spanien": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='24' height='16' fill='%23aa151b'/%3e%3crect y='5' height='6' width='24' fill='%23f1bf00'/%3e%3c/svg%3e",
      "Norwegen": "data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' width='24' height='16'%3e%3crect width='24' height='16' fill='%23ba0c2f'/%3e%3crect x='5' width='2' height='16' fill='%23015aaa'/%3e%3crect y='6' width='24' height='2' fill='%23015aaa'/%3e%3crect x='6' width='1' height='16' fill='%23fff'/%3e%3crect y='7' width='24' height='1' fill='%23fff'/%3e%3c/svg%3e",
    };

    /* =======================
       UTILITY CONSTANTS
       ======================= */

    const filterToggle = document.getElementById('filterToggle');
    const filterMenu = document.getElementById('filterMenu');
    const filterDropdown = document.querySelector('.filter-dropdown');
    const regionFilter = document.getElementById('regionFilter');
    const levelFilter = document.getElementById('levelFilter');
    const surfaceFilter = document.getElementById('surfaceFilter');
    const filterResetBtn = document.getElementById("filterResetBtn");
    const showMapBtn = document.getElementById("showMapBtn");
    const showGalleryBtn = document.getElementById("showGalleryBtn");
    const showGalleryListViewBtn = document.getElementById("showGalleryListViewBtn");
    const showGalleryGridViewBtn = document.getElementById("showGalleryGridViewBtn");
    const showGalleryGridViewMeteoBtn = document.getElementById("showGalleryGridViewMeteoBtn");
    const backBtn = document.getElementById("backBtn");
    const gallery = document.getElementById("gallery");
    

    let currentTrack;
    let allTracksLayers = [];
    let currentViewMode = "grid";  // default
    let lastGalleryViewMode = "grid"; // to remember last view mode

    /* =======================
     CODE FOR MAP
     ======================= */

    // Function to initialize map view
    function initializeMap() {
      document.getElementById("map").style.display = "block";
      document.getElementById("gallery").style.display = "none";
      showGalleryBtn.style.display = "block";
      showMapBtn.style.display = "none";
      showGalleryListViewBtn.style.display = "none";
      showGalleryGridViewBtn.style.display = "none";
      showGalleryGridViewMeteoBtn.style.display = "none";
      backBtn.style.display = "none";
      filterDropdown.style.display = "block";

      if (!mapInitialized) {
        map = L.map('map')
        const baseLayers = {
          "Standard": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap-Mitwirkende'
          }),
          "Topo": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenTopoMap'
          }),
          "Satellit": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles ¬© Esri'
          })
        };

        baseLayers["Standard"].addTo(map);
        L.control.layers(baseLayers).addTo(map);

        // Add tour title to map
        const tourTitleDiv = L.DomUtil.create('div', 'leaflet-tour-title');
        tourTitleDiv.innerHTML = '';

        // Insert it right after the zoom buttons
        const zoomContainer = map.zoomControl.getContainer();
        zoomContainer.parentNode.insertBefore(tourTitleDiv, zoomContainer.nextSibling);

        // Store reference for later updates
        map.tourTitleDiv = tourTitleDiv;

        mapInitialized = true;
      }
    }

    // Function to render a single tour in the map
    function renderMapSingleTour(gpxFile, tourPois) {
    
      filterDropdown.style.display = "none";
      showGalleryBtn.style.display = "none";
      backBtn.style.display = "block";

      currentViewMode = "map"

      const tour = touren.find(t => t.gpx === gpxFile);
      if (!tour) return;
      map.tourTitleDiv.innerHTML = `
      ${tour.bild && tour.bild.length ? `
        <img src="${tour.bild[0]}" alt="${tour.name}">
      ` : ''}
      <div class="leaflet-tour-title-text">
        <strong>${tour.name}</strong>
        <div>Strecke: ${tour.distanz}</div>
        <div>Belag: ${tour.strassenbelag}</div>
      </div>
    `;

      if (currentTrack) map.removeLayer(currentTrack);
      allTracksLayers.forEach(layer => map.removeLayer(layer));
      allTracksLayers = [];

      const startIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet-gpx@1.5.0/pin-icon-start.png',
        iconSize: [16, 24],
        iconAnchor: [8, 24],
        popupAnchor: [0, -24],
      });
      const endIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet-gpx@1.5.0/pin-icon-end.png',
        iconSize: [16, 24],
        iconAnchor: [8, 24],
        popupAnchor: [0, -24],
      });

      currentTrack = new L.GPX(gpxFile, {
        async: true,
        marker_options: {
          startIcon: startIcon,
          endIcon: endIcon,
          shadowUrl: 'https://unpkg.com/leaflet-gpx@1.5.0/pin-shadow.png'
        }
      }).on('loaded', function (e) {
        map.fitBounds(e.target.getBounds());
      
        // Render altitude profile
        document.getElementById("altitude-overlay").style.display = "block"; // show
        renderAltitudeProfile(gpxFile);

      }).addTo(map);
    }

    // Function to render the altitude profile
    function renderAltitudeProfile(fixedGpxFile) {
      fetch(fixedGpxFile)
        .then(response => response.text())
        .then(gpxText => {
          const parser = new DOMParser();
          const xml = parser.parseFromString(gpxText, "application/xml");
          const trkpts = xml.getElementsByTagName("trkpt");

          let dataPoints = [];
          let totalDist = 0;
          let lastLat = null, lastLon = null;

          function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371e3; 
            const toRad = deg => deg * Math.PI / 180;
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2)**2 +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
          }

          for (let i = 0; i < trkpts.length; i++) {
            let lat = parseFloat(trkpts[i].getAttribute("lat"));
            let lon = parseFloat(trkpts[i].getAttribute("lon"));
            let eleTag = trkpts[i].getElementsByTagName("ele")[0];
            if (!eleTag) continue;
            let ele = parseFloat(eleTag.textContent);

            if (lastLat !== null && lastLon !== null) {
              totalDist += haversine(lastLat, lastLon, lat, lon);
            }
            dataPoints.push({ x: totalDist / 1000, y: ele });

            lastLat = lat;
            lastLon = lon;
          }

          const maxDist = dataPoints[dataPoints.length - 1].x;  // e.g., 53 km
          let rawStep = maxDist <= 20 ? 1 : maxDist <= 100 ? 5 : maxDist <= 200 ? 10 : 20;
          let step = Math.max(5, Math.ceil(rawStep / 5) * 5);

          // Build an array of ticks to guarantee multiples of step appear
          const ticksArray = [];
          for (let v = 0; v <= maxDist; v += step) {
            ticksArray.push(v);
          }
          const lastTick = Math.floor(maxDist / step) * step;
          if (!ticksArray.includes(lastTick)) ticksArray.push(lastTick);

          const ctx = document.getElementById('altitudeChart').getContext('2d');

          // Destroy previous chart
          if (window.altitudeChartInstance) window.altitudeChartInstance.destroy();

          window.altitudeChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              datasets: [{
                label: 'Altitude (m)',
                data: dataPoints,
                borderColor: 'rgba(0, 120, 200, 1)',
                backgroundColor: 'rgba(135, 206, 250, 0.5)',
                fill: true,
                tension: 0.1,
                pointRadius: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: {
                x: {
                  type: 'linear',
                  title: { display: true, text: "Distanz (km)" },
                  min: 0,
                  max: maxDist,
                  grid: { display: false },
                  ticks: {
                    callback: function(value) {
                      // show only ticks from ticksArray, hide last decimal tick
                      return ticksArray.includes(value) ? value : null;
                    }
                  }
                },
                y: { title: { display: true, text: "H√∂he (m)" } }
              }
            }
          });
        });
    }


    // Function to render all tours on map (depending on filters)
    function renderMapFilteredTours() {

      document.getElementById("altitude-overlay").style.display = "none"; // hide
      
      initializeMap();
      currentViewMode = "map"

      if (currentTrack) {
        map.removeLayer(currentTrack);
        currentTrack = null;
      }
      allTracksLayers.forEach(layer => map.removeLayer(layer));
      allTracksLayers = [];

      const filtered = getFilteredTours(); // ‚Üê only filtered tours

      const groupBounds = L.latLngBounds();
      let loadedCount = 0;

       // Show spinner
        const spinner = document.getElementById("map-spinner");
        spinner.style.display = "block";
        
      const startIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet-gpx@1.5.0/pin-icon-start.png',
        iconSize: [16, 24],
        iconAnchor: [8, 24],
        popupAnchor: [0, -24],
      });
      const endIcon = L.icon({
        iconUrl: 'https://unpkg.com/leaflet-gpx@1.5.0/pin-icon-end.png',
        iconSize: [16, 24],
        iconAnchor: [8, 24],
        popupAnchor: [0, -24],
      });

      filtered.forEach(tour => {
        const gpxLayer = new L.GPX(tour.gpx, {
          async: true,
          marker_options: {
            startIcon,
            endIcon,
            shadowUrl: 'https://unpkg.com/leaflet-gpx@1.5.0/pin-shadow.png'
          }
        }).on('loaded', e => {
          groupBounds.extend(e.target.getBounds());
          loadedCount++;
          if (loadedCount === filtered.length) {
            map.fitBounds(groupBounds);
            spinner.style.display = "none"; // hide spinner when all GPX files loaded
          }
        })
          .on('addline', e => {
            const polyline = e.line;

            const tooltipContent = `
        <div class="tooltip-wrapper" style="cursor:pointer; text-align:center; max-width: 110px; padding: 2px; white-space: normal; font-size: 11px; line-height: 1.2;">
          <div style="font-weight: bold; margin-bottom: 2px; overflow-wrap: break-word;">${tour.name}</div>
          <div style="font-weight: normal; color: #555; margin-bottom: 3px;">${tour.distanz}</div>
          <img src="${tour.bild[0]}" alt="${tour.name}" style="width: 90px; height: auto; border-radius: 3px; box-shadow: 0 0 3px rgba(0,0,0,0.25);">
        </div>
      `;

            polyline.bindTooltip(tooltipContent, {
              permanent: true,
              direction: 'top',
              className: 'custom-tooltip',
              interactive: true
            });

            polyline.getTooltip().on('click', () => {
              document.querySelector(".leaflet-tour-title").textContent = tour.name;
              
              showGallery(tour); // Pass the selected tour to gallery
            });

            polyline.on('click', () => {
              map.fitBounds(polyline.getBounds());
            });

          })
          .addTo(map);

        allTracksLayers.push(gpxLayer);
      });

      if (filtered.length === 0) {
        document.querySelector(".leaflet-tour-title").textContent = "Keine Touren gefunden";
      } else {
        document.querySelector(".leaflet-tour-title").textContent = "Gefilterte Touren";
      }
    
    }

    /* =======================
     CODE FOR GALLERY
     ======================= */

    // Function to initialize gallery view

    function showGallery(selectedTour = null, viewMode = "grid") {
      
      document.getElementById("map").style.display = "none";
      document.getElementById("gallery").style.display = "flex";
      
      showGalleryBtn.style.display = "none";
      showMapBtn.style.display = "block";
      filterDropdown.style.display = "block";

      currentViewMode = viewMode;
      gallery.innerHTML = "";

      const filtered = getFilteredTours(selectedTour);

      if (filtered.length === 0) {
        gallery.innerHTML = `<div style="padding: 1rem; font-style: italic; color: #666;">
        Keine Touren gefunden, die den Filtern entsprechen.
        </div>`;
        return;
      }

      if (viewMode === "grid") {
        renderGridView(filtered);
      } else if (viewMode === "list") {
        renderListView(filtered);
      } else if (viewMode === "meteo") {
        renderGridViewMeteo(filtered);
      }
    }

    // Function to render tours in grid view

function renderGridView(filtered) {
  lastGalleryViewMode = "grid";
  showGalleryListViewBtn.style.display = "block";
  showGalleryGridViewBtn.style.display = "none";
  showGalleryGridViewMeteoBtn.style.display = "block";
  backBtn.style.display = "none";

  // Clear gallery
  gallery.innerHTML = "";

  // Group tours by region
  const grouped = {};
  filtered.forEach(t => {
    if (!grouped[t.region]) grouped[t.region] = [];
    grouped[t.region].push(t);
  });

  // Render each region section, sorted by number of tours
  Object.keys(grouped)
    .sort((a, b) => grouped[b].length - grouped[a].length) // most tours first
    // .sort((a, b) => grouped[a].length - grouped[b].length) // uncomment for fewest tours first
    .forEach(region => {
      // Sort tours alphabetically within each region
      grouped[region].sort((a, b) => a.name.localeCompare(b.name));

    // Region header
    const header = document.createElement("div");
    header.className = "country-header";
    header.innerHTML = `
      <img src="${flags[region] || ''}" alt="${region}" class="flag" style="height: 20px; vertical-align: middle; margin-right: 0.5rem;" />
      <span class="country-name" style="font-size: 1.2rem; font-weight: bold;">${region}</span>
    `;
    gallery.appendChild(header);

    // Render all tours for this region
    grouped[region].forEach((t, index) => {
      const galleryItem = document.createElement("div");
      galleryItem.className = "gallery-item";
      galleryItem.dataset.trackName = t.name;

      // Build carousel HTML
      const images = t.bild.map((filename, i) =>
        `<img src="${filename}" 
              alt="${t.name}" 
              class="carousel-image" 
              style="max-width: 100%; border-radius: 5px; display: ${i === 0 ? 'block' : 'none'};">`
      ).join("");

      galleryItem.innerHTML = `
        <div class="carousel" data-tour="${index}">
          <button class="carousel-arrow left">&#10094;</button>
          <div class="carousel-images">
            ${images}
          </div>
          <button class="carousel-arrow right">&#10095;</button>
        </div>
        <div class="tour-title" style="font-weight: bold; margin-top: 0.5rem;">
          <img src="${flags[t.region] || ''}" alt="${t.region}" class="flag" style="height: 16px; vertical-align: middle; margin-right: 0.5rem;" />
          ${t.name}
        </div>
        <div class="tour-desc">${t.beschreibung}</div>
        <div class="tour-info">Strecke: ${t.distanz}</div>
        <div class="tour-besonderheiten">Besonderheiten: ${t.besonderheiten}</div>
        <div class="tour-strassenbelag">Strassenbelag: ${t.strassenbelag}</div>
        <a class="tour-download" href="${t.gpx}" download style="display: inline-block; margin-top: 0.5rem;">‚û§ GPX herunterladen</a>
      `;

      // Click anywhere on tour box ‚Üí open tour in map
      galleryItem.addEventListener("click", (event) => {
        if (
          event.target.closest(".carousel-arrow") || 
          event.target.closest(".tour-download")
        ) {
          return;
        }
        initializeMap();
        renderMapSingleTour(t.gpx);
      });

      gallery.appendChild(galleryItem);
    });
  });

  // Enable carousel navigation after items are added
  setupCarousels();
}

    // Function to setup carousels for grid view

    function setupCarousels() {
      document.querySelectorAll(".carousel").forEach(carousel => {
        const images = carousel.querySelectorAll(".carousel-image");
        let currentIndex = 0;

        carousel.querySelector(".left").addEventListener("click", e => {
          e.stopPropagation(); // prevent triggering map click
          images[currentIndex].style.display = "none";
          currentIndex = (currentIndex - 1 + images.length) % images.length;
          images[currentIndex].style.display = "block";
        });

        carousel.querySelector(".right").addEventListener("click", e => {
          e.stopPropagation(); // prevent triggering map click
          images[currentIndex].style.display = "none";
          currentIndex = (currentIndex + 1) % images.length;
          images[currentIndex].style.display = "block";
        });
      });
    }

    // Function to render tours in grid view with weather widget

    function renderGridViewMeteo(filtered) {
      lastGalleryViewMode = "grid";
      filterDropdown.style.display = "none";
      showMapBtn.style.display = "none";
      showGalleryListViewBtn.style.display = "none";
      showGalleryGridViewBtn.style.display = "none";
      showGalleryGridViewMeteoBtn.style.display = "none";
      backBtn.style.display = "flex";

    // 1. Group tours by region
    const grouped = {};
    filtered.forEach(t => {
      if (!grouped[t.region]) grouped[t.region] = [];
      grouped[t.region].push(t);
    });

    // 2. Sort regions by number of tours, then loop
    Object.keys(grouped)
      .sort((a, b) => grouped[b].length - grouped[a].length) // most tours first
      .forEach(region => {
        // Sort tours alphabetically inside region
        grouped[region].sort((a, b) => a.name.localeCompare(b.name));

        // 3. Create region header
        const header = document.createElement("div");
        header.className = "country-header";
        header.innerHTML = `
          <img src="${flags[region] || ''}" alt="${region}" class="flag" style="height: 20px; vertical-align: middle; margin-right: 0.5rem;" />
          <span class="country-name" style="font-size: 1.2rem; font-weight: bold;">${region}</span>
        `;
        gallery.appendChild(header);

        // 4. Render tours for this region
        grouped[region].forEach((t, index) => {
          const galleryItem = document.createElement("div");
          galleryItem.className = "gallery-item";
          galleryItem.dataset.trackName = t.name;

        galleryItem.innerHTML = `

          <div class="tour-title" style="font-weight: bold; margin-top: 0.1rem;">
            <img src="${flags[t.region] || ''}" alt="${t.region}" class="flag" style="height: 16px; vertical-align: middle; margin-right: 0.1rem;" />
            ${t.name}
          </div>
          
          <!-- Weather Widget -->
          <div class="tour-weather" style="margin-top: 1rem;">
          <iframe
            src="https://www.meteoblue.com/de/weather/widget/daily/${t.cityId.toLowerCase().replace(/\s+/g,'-')}_${t.region.toLowerCase()}_${t.cityId}?geoloc=fixed&days=5&tempunit=CELSIUS&windunit=KILOMETER_PER_HOUR&precipunit=MILLIMETER&coloured=coloured&pictoicon=1&maxtemperature=1&mintemperature=1&windspeed=1&windgust=0&winddirection=0&uv=0&humidity=0&precipitation=1&precipitationprobability=1&spot=0&pressure=0&layout=light"
            frameborder="0"
            scrolling="NO"
            allowtransparency="true"
            sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"
            style="width: 230px; height: 270px">
          </iframe>
          <div>
            <a href="https://www.meteoblue.com/de/weather/week/${t.cityId.toLowerCase().replace(/\s+/g,'-')}_${t.region.toLowerCase()}_${t.cityId}" target="_blank" rel="noopener"/a>
          </div>
        </div>
        `;

        gallery.appendChild(galleryItem);
      });
    });
    }

    // Function to render tours in list view

    function renderListView(filtered) {

      lastGalleryViewMode = "list";
      showGalleryListViewBtn.style.display = "none";
      showGalleryGridViewBtn.style.display = "block";
      showGalleryGridViewMeteoBtn.style.display = "none";
      backBtn.style.display = "none";

      const grouped = {};
      filtered.forEach(t => {
        if (!grouped[t.region]) grouped[t.region] = [];
        grouped[t.region].push(t);
      });

      Object.keys(grouped).forEach(region => {
        // Country header
        const header = document.createElement("div");
        header.className = "country-header";
        header.innerHTML = `
      <img src="${flags[region] || ''}" alt="${region}" class="flag" />
      <span class="country-name">${region}</span>
    `;
        gallery.appendChild(header);

        // Create table for this country
        const table = document.createElement("table");
        table.className = "tour-table";

        // Table header row
        table.innerHTML = `
      <thead>
        <tr>
          <th>Tour</th>
          <th>Distanz</th>
          <th>Schwierigkeit</th>
          <th>Strassenbelag</th>
          <th>Download</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    `;

        const tbody = table.querySelector("tbody");

        // Add a row for each tour
        grouped[region].forEach(t => {
          const row = document.createElement("tr");
          row.innerHTML = `
        <td class="tour-name">${t.name}</td>
        <td class="tour-distance">${t.distanz}</td>
        <td class="tour-difficulty">${t.schwierigkeit}</td>
        <td class="tour-surface">${t.strassenbelag}</td>
        <td class="tour-download"><a href="${t.gpx}" download>‚û§ GPX herunterladen</a></td>`;  

          // Click to open in map
          row.addEventListener("click", () => {
            initializeMap();
            renderMapSingleTour(t.gpx);
          });

          tbody.appendChild(row);
        });

        gallery.appendChild(table);
      });
    }

    /* =======================
       FILTER HANDLING
       ======================= */

    // Open/close filter dropdown
    filterToggle.addEventListener('click', () => {
      const isActive = filterMenu.classList.toggle('active');
      filterToggle.setAttribute('aria-expanded', isActive ? 'true' : 'false');
      filterMenu.setAttribute('aria-hidden', isActive ? 'false' : 'true');
    });

    // Open filter menu
    function openFilterMenu() {
      filterMenu.classList.add('active');
      filterToggle.setAttribute('aria-expanded', 'true');
      filterMenu.setAttribute('aria-hidden', 'false');
    }

    // Close filter menu
    function closeFilterMenu() {
      filterMenu.classList.remove('active');
      filterToggle.setAttribute('aria-expanded', 'false');
      filterMenu.setAttribute('aria-hidden', 'true');
    }

    // Filter reset button functionality
    filterResetBtn.addEventListener("click", () => {
      regionFilter.value = "";
      levelFilter.value = "";
      surfaceFilter.value = "";
      if (currentViewMode === "grid") {
        showGallery(null, "grid");
        closeFilterMenu();
      } else if (currentViewMode === "list") {
        showGallery(null, "list");
        closeFilterMenu();
      } else if (currentViewMode === "map") {
        renderMapFilteredTours();
        closeFilterMenu();
      }
    });

    // Filter function
    function onFilterChange() {
      if (currentViewMode === "grid") {
        showGallery(null, "grid");
      } else if (currentViewMode === "list") {
        showGallery(null, "list");
      } else if (currentViewMode === "map") {
        renderMapFilteredTours();
      }
      closeFilterMenu();
    }

    // Function to get filtered tours based on selected filters
    // If a specific tour is selected, return that tour only
    // Otherwise, return all tours that match the filters
    // If no filters are selected, return all tours

    function getFilteredTours(selectedTour = null) {
      const regionValue = regionFilter.value.toLowerCase();
      const levelValue = levelFilter.value.toLowerCase();
      const surfaceValue = surfaceFilter.value.toLowerCase();

      if (selectedTour) {
        return [selectedTour];
      }

      return touren.filter(t =>
        (!regionValue || t.region.toLowerCase() === regionValue) &&
        (!levelValue || t.schwierigkeit.toLowerCase() === levelValue) &&
        (!surfaceValue || t.strassenbelag.toLowerCase() === surfaceValue)
      );
    }

    regionFilter.addEventListener("change", onFilterChange);
    levelFilter.addEventListener("change", onFilterChange);
    surfaceFilter.addEventListener("change", onFilterChange);

    /* =======================
       BUTTON HANDLERS
       ======================= */
    
    // Show gallery view
    showGalleryBtn.addEventListener("click", () => showGallery(null, lastGalleryViewMode));

    // Show map view
    showMapBtn.addEventListener("click", () => renderMapFilteredTours(true));

    // Show gallery in list view
    showGalleryListViewBtn.addEventListener("click", () => showGallery(null, "list"));

    // Show gallery in grid view
    showGalleryGridViewBtn.addEventListener("click", () => showGallery(null, "grid"));

    // Show gallery in grid view with weather widget
    showGalleryGridViewMeteoBtn.addEventListener("click", () => showGallery(null, "meteo"));

    // Show gallery in grid view coming from weather widget view
    backBtn.addEventListener("click", () => showGallery(null, "grid"));

    /* =======================
       ACTIONS ON LOAD
      ======================= */

    // Show gallery by default
 
    showGallery();

    // One-time tip overlay
    if (!localStorage.getItem('tourClickHintShown')) {
      const hint = document.createElement('div');
      hint.textContent = 'üí° Klicke auf eine Tour, um sie auf der Karte zu sehen.';
      hint.style.position = 'fixed';
      hint.style.top = '75px'; // adjust depending on your header height
      hint.style.left = '50%';
      hint.style.transform = 'translateX(-50%)';
      hint.style.background = 'rgba(0,0,0,0.65)';
      hint.style.color = '#fff';
      hint.style.padding = '8px 14px';
      hint.style.borderRadius = '5px';
      hint.style.fontSize = '14px';
      hint.style.zIndex = 9999;
      hint.style.opacity = '0';
      hint.style.transition = 'opacity 0.5s ease';

      document.body.appendChild(hint);

      // Fade in
      requestAnimationFrame(() => {
        hint.style.opacity = '1';
      });

      // Fade out after 3 seconds
      setTimeout(() => {
        hint.style.opacity = '0';
        setTimeout(() => hint.remove(), 500);
      }, 3000);
      
      localStorage.setItem('tourClickHintShown', 'true');
    }

  </script>

</body>

</html>